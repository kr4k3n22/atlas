{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport type { NextRequest } from \"next/server\";\nimport { jwtVerify } from \"jose\";\n\nconst COOKIE_NAME = \"atlas_session\";\nconst ISSUER = \"atlas-hitl-ui\";\nconst AUDIENCE = \"atlas-hitl-ui\";\n\nfunction getSecret(): Uint8Array | null {\n  const s = process.env.AUTH_SECRET;\n  if (!s || s.length < 16) return null;\n  return new TextEncoder().encode(s);\n}\n\nasync function readRole(req: NextRequest): Promise<\"user\" | \"approver\" | null> {\n  const token = req.cookies.get(COOKIE_NAME)?.value;\n  if (!token) return null;\n\n  const secret = getSecret();\n  if (!secret) return null;\n\n  try {\n    const { payload } = await jwtVerify(token, secret, { issuer: ISSUER, audience: AUDIENCE });\n    const role = String(payload.role || \"\");\n    if (role === \"user\" || role === \"approver\") return role;\n    return null;\n  } catch {\n    return null;\n  }\n}\n\nexport async function middleware(req: NextRequest) {\n  const path = req.nextUrl.pathname;\n\n  const isApproverArea = path.startsWith(\"/cases\") || path.startsWith(\"/settings\");\n  const isUserArea = path.startsWith(\"/chat\");\n\n  if (!isApproverArea && !isUserArea) return NextResponse.next();\n\n  const role = await readRole(req);\n\n  if (isApproverArea) {\n    if (role === \"approver\") return NextResponse.next();\n    const url = req.nextUrl.clone();\n    url.pathname = \"/approver/login\";\n    url.searchParams.set(\"next\", path);\n    return NextResponse.redirect(url);\n  }\n\n  if (isUserArea) {\n    if (role === \"user\") return NextResponse.next();\n    const url = req.nextUrl.clone();\n    url.pathname = \"/login\";\n    url.searchParams.set(\"next\", path);\n    return NextResponse.redirect(url);\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: [\"/cases/:path*\", \"/settings/:path*\", \"/chat/:path*\"],\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAEA;;;AAEA,MAAM,cAAc;AACpB,MAAM,SAAS;AACf,MAAM,WAAW;AAEjB,SAAS;IACP,MAAM,IAAI,QAAQ,GAAG,CAAC,WAAW;IACjC,IAAI,CAAC,KAAK,EAAE,MAAM,GAAG,IAAI,OAAO;IAChC,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AAEA,eAAe,SAAS,GAAgB;IACtC,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc;IAC5C,IAAI,CAAC,OAAO,OAAO;IAEnB,MAAM,SAAS;IACf,IAAI,CAAC,QAAQ,OAAO;IAEpB,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,4KAAS,EAAC,OAAO,QAAQ;YAAE,QAAQ;YAAQ,UAAU;QAAS;QACxF,MAAM,OAAO,OAAO,QAAQ,IAAI,IAAI;QACpC,IAAI,SAAS,UAAU,SAAS,YAAY,OAAO;QACnD,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,WAAW,GAAgB;IAC/C,MAAM,OAAO,IAAI,OAAO,CAAC,QAAQ;IAEjC,MAAM,iBAAiB,KAAK,UAAU,CAAC,aAAa,KAAK,UAAU,CAAC;IACpE,MAAM,aAAa,KAAK,UAAU,CAAC;IAEnC,IAAI,CAAC,kBAAkB,CAAC,YAAY,OAAO,gMAAY,CAAC,IAAI;IAE5D,MAAM,OAAO,MAAM,SAAS;IAE5B,IAAI,gBAAgB;QAClB,IAAI,SAAS,YAAY,OAAO,gMAAY,CAAC,IAAI;QACjD,MAAM,MAAM,IAAI,OAAO,CAAC,KAAK;QAC7B,IAAI,QAAQ,GAAG;QACf,IAAI,YAAY,CAAC,GAAG,CAAC,QAAQ;QAC7B,OAAO,gMAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,IAAI,YAAY;QACd,IAAI,SAAS,QAAQ,OAAO,gMAAY,CAAC,IAAI;QAC7C,MAAM,MAAM,IAAI,OAAO,CAAC,KAAK;QAC7B,IAAI,QAAQ,GAAG;QACf,IAAI,YAAY,CAAC,GAAG,CAAC,QAAQ;QAC7B,OAAO,gMAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,OAAO,gMAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;QAAiB;QAAoB;KAAe;AAChE"}}]
}