{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/atlas/atlas-hitl-ui/src/lib/auth.ts"],"sourcesContent":["import { SignJWT, jwtVerify } from \"jose\";\nimport { cookies } from \"next/headers\";\nimport type { Role } from \"@/lib/authStore\";\n\nconst COOKIE_NAME = \"atlas_session\";\nconst ISSUER = \"atlas-hitl-ui\";\nconst AUDIENCE = \"atlas-hitl-ui\";\n\nfunction getSecret(): Uint8Array {\n  const s = process.env.AUTH_SECRET;\n  if (!s || s.length < 16) {\n    // In production, require a strong secret. In dev, we still need something.\n    throw new Error(\"AUTH_SECRET missing or too short. Set it in .env.local\");\n  }\n  return new TextEncoder().encode(s);\n}\n\nexport type SessionUser = {\n  id: string;\n  email: string;\n  displayName: string;\n  role: Role;\n};\n\nexport async function setSession(user: SessionUser) {\n  const secret = getSecret();\n\n  const token = await new SignJWT({\n    email: user.email,\n    displayName: user.displayName,\n    role: user.role,\n  })\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setSubject(user.id)\n    .setIssuer(ISSUER)\n    .setAudience(AUDIENCE)\n    .setIssuedAt()\n    .setExpirationTime(\"7d\")\n    .sign(secret);\n\n  const jar = await cookies();\n  jar.set(COOKIE_NAME, token, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n  });\n}\n\nexport async function clearSession() {\n  const jar = await cookies();\n  jar.set(COOKIE_NAME, \"\", {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    maxAge: 0,\n  });\n}\n\nexport async function getSession(): Promise<SessionUser | null> {\n  const jar = await cookies();\n  const token = jar.get(COOKIE_NAME)?.value;\n  if (!token) return null;\n\n  try {\n    const secret = getSecret();\n    const { payload } = await jwtVerify(token, secret, {\n      issuer: ISSUER,\n      audience: AUDIENCE,\n    });\n\n    const id = String(payload.sub || \"\");\n    const email = String(payload.email || \"\");\n    const displayName = String(payload.displayName || \"\");\n    const role = String(payload.role || \"\") as any;\n\n    if (!id || !email || !displayName) return null;\n    if (role !== \"user\" && role !== \"approver\") return null;\n\n    return { id, email, displayName, role };\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;AACA;;;AAGA,MAAM,cAAc;AACpB,MAAM,SAAS;AACf,MAAM,WAAW;AAEjB,SAAS;IACP,MAAM,IAAI,QAAQ,GAAG,CAAC,WAAW;IACjC,IAAI,CAAC,KAAK,EAAE,MAAM,GAAG,IAAI;QACvB,2EAA2E;QAC3E,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AASO,eAAe,WAAW,IAAiB;IAChD,MAAM,SAAS;IAEf,MAAM,QAAQ,MAAM,IAAI,kKAAO,CAAC;QAC9B,OAAO,KAAK,KAAK;QACjB,aAAa,KAAK,WAAW;QAC7B,MAAM,KAAK,IAAI;IACjB,GACG,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,UAAU,CAAC,KAAK,EAAE,EAClB,SAAS,CAAC,QACV,WAAW,CAAC,UACZ,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;IAER,MAAM,MAAM,MAAM,IAAA,4IAAO;IACzB,IAAI,GAAG,CAAC,aAAa,OAAO;QAC1B,UAAU;QACV,UAAU;QACV,QAAQ,oDAAyB;QACjC,MAAM;IACR;AACF;AAEO,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO;IACzB,IAAI,GAAG,CAAC,aAAa,IAAI;QACvB,UAAU;QACV,UAAU;QACV,QAAQ,oDAAyB;QACjC,MAAM;QACN,QAAQ;IACV;AACF;AAEO,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO;IACzB,MAAM,QAAQ,IAAI,GAAG,CAAC,cAAc;IACpC,IAAI,CAAC,OAAO,OAAO;IAEnB,IAAI;QACF,MAAM,SAAS;QACf,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO,QAAQ;YACjD,QAAQ;YACR,UAAU;QACZ;QAEA,MAAM,KAAK,OAAO,QAAQ,GAAG,IAAI;QACjC,MAAM,QAAQ,OAAO,QAAQ,KAAK,IAAI;QACtC,MAAM,cAAc,OAAO,QAAQ,WAAW,IAAI;QAClD,MAAM,OAAO,OAAO,QAAQ,IAAI,IAAI;QAEpC,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,aAAa,OAAO;QAC1C,IAAI,SAAS,UAAU,SAAS,YAAY,OAAO;QAEnD,OAAO;YAAE;YAAI;YAAO;YAAa;QAAK;IACxC,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/atlas/atlas-hitl-ui/src/app/api/auth/me/route.ts"],"sourcesContent":["import { getSession } from \"@/lib/auth\";\n\nexport async function GET() {\n  const s = await getSession();\n  return Response.json({ session: s });\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe;IACpB,MAAM,IAAI,MAAM,IAAA,kIAAU;IAC1B,OAAO,SAAS,IAAI,CAAC;QAAE,SAAS;IAAE;AACpC"}}]
}