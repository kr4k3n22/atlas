{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///home/atlas/atlas-hitl-ui/src/lib/authStore.ts"],"sourcesContent":["import fs from \"node:fs/promises\";\nimport path from \"node:path\";\nimport { nanoid } from \"nanoid\";\nimport bcrypt from \"bcryptjs\";\n\nexport type Role = \"user\" | \"approver\";\n\nexport type StoredUser = {\n  id: string;\n  email: string;\n  displayName: string;\n  role: Role;\n  passwordHash: string;\n  createdAt: string;\n  lastLoginAt?: string;\n};\n\nconst DATA_DIR = path.join(process.cwd(), \".data\");\nconst USERS_PATH = path.join(DATA_DIR, \"users.json\");\n\nasync function readUsers(): Promise<StoredUser[]> {\n  try {\n    const raw = await fs.readFile(USERS_PATH, \"utf-8\");\n    const parsed = JSON.parse(raw);\n    if (!Array.isArray(parsed)) return [];\n    return parsed as StoredUser[];\n  } catch {\n    return [];\n  }\n}\n\nasync function writeUsers(users: StoredUser[]) {\n  await fs.mkdir(DATA_DIR, { recursive: true });\n  const tmp = USERS_PATH + \".tmp\";\n  await fs.writeFile(tmp, JSON.stringify(users, null, 2), \"utf-8\");\n  await fs.rename(tmp, USERS_PATH);\n}\n\nexport async function findUserByEmail(email: string): Promise<StoredUser | null> {\n  const users = await readUsers();\n  const u = users.find((x) => x.email.toLowerCase() === email.toLowerCase());\n  return u ?? null;\n}\n\nexport async function findUserById(id: string): Promise<StoredUser | null> {\n  const users = await readUsers();\n  const u = users.find((x) => x.id === id);\n  return u ?? null;\n}\n\nexport async function createUser(input: {\n  email: string;\n  displayName: string;\n  password: string;\n  role: Role;\n}): Promise<StoredUser> {\n  const users = await readUsers();\n\n  const emailNorm = input.email.toLowerCase().trim();\n  if (users.some((x) => x.email.toLowerCase() === emailNorm)) {\n    throw new Error(\"Email already exists\");\n  }\n\n  // bcrypt cost 12 is a reasonable baseline for dev/small deployments.\n  const passwordHash = await bcrypt.hash(input.password, 12);\n\n  const u: StoredUser = {\n    id: nanoid(),\n    email: emailNorm,\n    displayName: input.displayName.trim(),\n    role: input.role,\n    passwordHash,\n    createdAt: new Date().toISOString(),\n  };\n\n  users.push(u);\n  await writeUsers(users);\n  return u;\n}\n\nexport async function verifyPassword(user: StoredUser, password: string): Promise<boolean> {\n  return bcrypt.compare(password, user.passwordHash);\n}\n\nexport async function touchLastLogin(userId: string) {\n  const users = await readUsers();\n  const idx = users.findIndex((x) => x.id === userId);\n  if (idx === -1) return;\n  users[idx].lastLoginAt = new Date().toISOString();\n  await writeUsers(users);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AACA;AACA;;;;;AAcA,MAAM,WAAW,4HAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;AAC1C,MAAM,aAAa,4HAAI,CAAC,IAAI,CAAC,UAAU;AAEvC,eAAe;IACb,IAAI;QACF,MAAM,MAAM,MAAM,gJAAE,CAAC,QAAQ,CAAC,YAAY;QAC1C,MAAM,SAAS,KAAK,KAAK,CAAC;QAC1B,IAAI,CAAC,MAAM,OAAO,CAAC,SAAS,OAAO,EAAE;QACrC,OAAO;IACT,EAAE,OAAM;QACN,OAAO,EAAE;IACX;AACF;AAEA,eAAe,WAAW,KAAmB;IAC3C,MAAM,gJAAE,CAAC,KAAK,CAAC,UAAU;QAAE,WAAW;IAAK;IAC3C,MAAM,MAAM,aAAa;IACzB,MAAM,gJAAE,CAAC,SAAS,CAAC,KAAK,KAAK,SAAS,CAAC,OAAO,MAAM,IAAI;IACxD,MAAM,gJAAE,CAAC,MAAM,CAAC,KAAK;AACvB;AAEO,eAAe,gBAAgB,KAAa;IACjD,MAAM,QAAQ,MAAM;IACpB,MAAM,IAAI,MAAM,IAAI,CAAC,CAAC,IAAM,EAAE,KAAK,CAAC,WAAW,OAAO,MAAM,WAAW;IACvE,OAAO,KAAK;AACd;AAEO,eAAe,aAAa,EAAU;IAC3C,MAAM,QAAQ,MAAM;IACpB,MAAM,IAAI,MAAM,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK;IACrC,OAAO,KAAK;AACd;AAEO,eAAe,WAAW,KAKhC;IACC,MAAM,QAAQ,MAAM;IAEpB,MAAM,YAAY,MAAM,KAAK,CAAC,WAAW,GAAG,IAAI;IAChD,IAAI,MAAM,IAAI,CAAC,CAAC,IAAM,EAAE,KAAK,CAAC,WAAW,OAAO,YAAY;QAC1D,MAAM,IAAI,MAAM;IAClB;IAEA,qEAAqE;IACrE,MAAM,eAAe,MAAM,8IAAM,CAAC,IAAI,CAAC,MAAM,QAAQ,EAAE;IAEvD,MAAM,IAAgB;QACpB,IAAI,IAAA,2JAAM;QACV,OAAO;QACP,aAAa,MAAM,WAAW,CAAC,IAAI;QACnC,MAAM,MAAM,IAAI;QAChB;QACA,WAAW,IAAI,OAAO,WAAW;IACnC;IAEA,MAAM,IAAI,CAAC;IACX,MAAM,WAAW;IACjB,OAAO;AACT;AAEO,eAAe,eAAe,IAAgB,EAAE,QAAgB;IACrE,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU,KAAK,YAAY;AACnD;AAEO,eAAe,eAAe,MAAc;IACjD,MAAM,QAAQ,MAAM;IACpB,MAAM,MAAM,MAAM,SAAS,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK;IAC5C,IAAI,QAAQ,CAAC,GAAG;IAChB,KAAK,CAAC,IAAI,CAAC,WAAW,GAAG,IAAI,OAAO,WAAW;IAC/C,MAAM,WAAW;AACnB"}},
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///home/atlas/atlas-hitl-ui/src/lib/auth.ts"],"sourcesContent":["import { SignJWT, jwtVerify } from \"jose\";\nimport { cookies } from \"next/headers\";\nimport type { Role } from \"@/lib/authStore\";\n\nconst COOKIE_NAME = \"atlas_session\";\nconst ISSUER = \"atlas-hitl-ui\";\nconst AUDIENCE = \"atlas-hitl-ui\";\n\nfunction getSecret(): Uint8Array {\n  const s = process.env.AUTH_SECRET;\n  if (!s || s.length < 16) {\n    // In production, require a strong secret. In dev, we still need something.\n    throw new Error(\"AUTH_SECRET missing or too short. Set it in .env.local\");\n  }\n  return new TextEncoder().encode(s);\n}\n\nexport type SessionUser = {\n  id: string;\n  email: string;\n  displayName: string;\n  role: Role;\n};\n\nexport async function setSession(user: SessionUser) {\n  const secret = getSecret();\n\n  const token = await new SignJWT({\n    email: user.email,\n    displayName: user.displayName,\n    role: user.role,\n  })\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setSubject(user.id)\n    .setIssuer(ISSUER)\n    .setAudience(AUDIENCE)\n    .setIssuedAt()\n    .setExpirationTime(\"7d\")\n    .sign(secret);\n\n  const jar = await cookies();\n  jar.set(COOKIE_NAME, token, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n  });\n}\n\nexport async function clearSession() {\n  const jar = await cookies();\n  jar.set(COOKIE_NAME, \"\", {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    maxAge: 0,\n  });\n}\n\nexport async function getSession(): Promise<SessionUser | null> {\n  const jar = await cookies();\n  const token = jar.get(COOKIE_NAME)?.value;\n  if (!token) return null;\n\n  try {\n    const secret = getSecret();\n    const { payload } = await jwtVerify(token, secret, {\n      issuer: ISSUER,\n      audience: AUDIENCE,\n    });\n\n    const id = String(payload.sub || \"\");\n    const email = String(payload.email || \"\");\n    const displayName = String(payload.displayName || \"\");\n    const role = String(payload.role || \"\") as any;\n\n    if (!id || !email || !displayName) return null;\n    if (role !== \"user\" && role !== \"approver\") return null;\n\n    return { id, email, displayName, role };\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;AACA;;;AAGA,MAAM,cAAc;AACpB,MAAM,SAAS;AACf,MAAM,WAAW;AAEjB,SAAS;IACP,MAAM,IAAI,QAAQ,GAAG,CAAC,WAAW;IACjC,IAAI,CAAC,KAAK,EAAE,MAAM,GAAG,IAAI;QACvB,2EAA2E;QAC3E,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AASO,eAAe,WAAW,IAAiB;IAChD,MAAM,SAAS;IAEf,MAAM,QAAQ,MAAM,IAAI,kKAAO,CAAC;QAC9B,OAAO,KAAK,KAAK;QACjB,aAAa,KAAK,WAAW;QAC7B,MAAM,KAAK,IAAI;IACjB,GACG,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,UAAU,CAAC,KAAK,EAAE,EAClB,SAAS,CAAC,QACV,WAAW,CAAC,UACZ,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;IAER,MAAM,MAAM,MAAM,IAAA,4IAAO;IACzB,IAAI,GAAG,CAAC,aAAa,OAAO;QAC1B,UAAU;QACV,UAAU;QACV,QAAQ,oDAAyB;QACjC,MAAM;IACR;AACF;AAEO,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO;IACzB,IAAI,GAAG,CAAC,aAAa,IAAI;QACvB,UAAU;QACV,UAAU;QACV,QAAQ,oDAAyB;QACjC,MAAM;QACN,QAAQ;IACV;AACF;AAEO,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO;IACzB,MAAM,QAAQ,IAAI,GAAG,CAAC,cAAc;IACpC,IAAI,CAAC,OAAO,OAAO;IAEnB,IAAI;QACF,MAAM,SAAS;QACf,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO,QAAQ;YACjD,QAAQ;YACR,UAAU;QACZ;QAEA,MAAM,KAAK,OAAO,QAAQ,GAAG,IAAI;QACjC,MAAM,QAAQ,OAAO,QAAQ,KAAK,IAAI;QACtC,MAAM,cAAc,OAAO,QAAQ,WAAW,IAAI;QAClD,MAAM,OAAO,OAAO,QAAQ,IAAI,IAAI;QAEpC,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,aAAa,OAAO;QAC1C,IAAI,SAAS,UAAU,SAAS,YAAY,OAAO;QAEnD,OAAO;YAAE;YAAI;YAAO;YAAa;QAAK;IACxC,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 235, "column": 0}, "map": {"version":3,"sources":["file:///home/atlas/atlas-hitl-ui/src/app/api/auth/login/route.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { findUserByEmail, verifyPassword, touchLastLogin } from \"@/lib/authStore\";\nimport { setSession } from \"@/lib/auth\";\n\nconst Body = z.object({\n  email: z.string().email(),\n  password: z.string().min(1).max(200),\n  role: z.enum([\"user\", \"approver\"]),\n});\n\nfunction sleep(ms: number) {\n  return new Promise((r) => setTimeout(r, ms));\n}\n\nexport async function POST(req: Request) {\n  const body = Body.parse(await req.json());\n\n  // Cheap timing noise to reduce super-obvious oracle behavior in dev.\n  // Real deployments: add rate limiting + lockouts + monitoring.\n  await sleep(80);\n\n  const u = await findUserByEmail(body.email);\n  if (!u) return new Response(\"Invalid credentials\", { status: 401 });\n\n  if (u.role !== body.role) return new Response(\"Invalid credentials\", { status: 401 });\n\n  const ok = await verifyPassword(u, body.password);\n  if (!ok) return new Response(\"Invalid credentials\", { status: 401 });\n\n  await touchLastLogin(u.id);\n  await setSession({ id: u.id, email: u.email, displayName: u.displayName, role: u.role });\n\n  return Response.json({ ok: true, role: u.role });\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,OAAO,oLAAC,CAAC,MAAM,CAAC;IACpB,OAAO,oLAAC,CAAC,MAAM,GAAG,KAAK;IACvB,UAAU,oLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC;IAChC,MAAM,oLAAC,CAAC,IAAI,CAAC;QAAC;QAAQ;KAAW;AACnC;AAEA,SAAS,MAAM,EAAU;IACvB,OAAO,IAAI,QAAQ,CAAC,IAAM,WAAW,GAAG;AAC1C;AAEO,eAAe,KAAK,GAAY;IACrC,MAAM,OAAO,KAAK,KAAK,CAAC,MAAM,IAAI,IAAI;IAEtC,qEAAqE;IACrE,+DAA+D;IAC/D,MAAM,MAAM;IAEZ,MAAM,IAAI,MAAM,IAAA,4IAAe,EAAC,KAAK,KAAK;IAC1C,IAAI,CAAC,GAAG,OAAO,IAAI,SAAS,uBAAuB;QAAE,QAAQ;IAAI;IAEjE,IAAI,EAAE,IAAI,KAAK,KAAK,IAAI,EAAE,OAAO,IAAI,SAAS,uBAAuB;QAAE,QAAQ;IAAI;IAEnF,MAAM,KAAK,MAAM,IAAA,2IAAc,EAAC,GAAG,KAAK,QAAQ;IAChD,IAAI,CAAC,IAAI,OAAO,IAAI,SAAS,uBAAuB;QAAE,QAAQ;IAAI;IAElE,MAAM,IAAA,2IAAc,EAAC,EAAE,EAAE;IACzB,MAAM,IAAA,kIAAU,EAAC;QAAE,IAAI,EAAE,EAAE;QAAE,OAAO,EAAE,KAAK;QAAE,aAAa,EAAE,WAAW;QAAE,MAAM,EAAE,IAAI;IAAC;IAEtF,OAAO,SAAS,IAAI,CAAC;QAAE,IAAI;QAAM,MAAM,EAAE,IAAI;IAAC;AAChD"}}]
}